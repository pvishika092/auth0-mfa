<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Set Up Two-Factor Authentication</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
  :root {
    --primary: #3aa378;
    --primary-soft: #42ce9110;
    --text-main: #0f172a;
    --text-muted: #475569;
    --border-soft: #e5e7eb;
    --card-bg: #ffffff;
  }

  * {
    box-sizing: border-box;
    font-family: -apple-system, BlinkMacSystemFont, "Inter", "Segoe UI", sans-serif;
  }

  body {
    margin: 0;
    min-height: 100vh;
    background:
      linear-gradient(rgba(255,255,255,0.85), rgba(255,255,255,0.85)),
      url('https://holmes-static-assets.s3.ap-south-1.amazonaws.com/Pantopic-bg-light.png');
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-main);
  }

  .container {
    width: 100%;
    max-width: 1200px;
    padding: 32px;
  }

  .header {
    text-align: center;
    margin-bottom: 32px;
  }

  .header h1 {
    font-size: 30px;
  }

  .split {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
  }

  .card {
    background: var(--card-bg);
    border-radius: 20px;
    padding: 28px;
    box-shadow: 0 18px 40px rgba(15, 23, 42, 0.08);
    border: 1px solid var(--border-soft);
  }

  .step { display: flex; gap: 16px; margin-bottom: 28px; }
  .step-number { width: 36px; height: 36px; border-radius: 12px; flex-shrink: 0; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; }
  .step h3 { margin: 0 0 6px; font-size: 16px; }
  .step p { font-size: 14px; color: var(--text-muted); line-height: 1.5; }

  .qr-title { text-align: center; font-weight: 600; margin-bottom: 6px; }
  .qr-sub { text-align: center; font-size: 13px; color: var(--text-muted); margin-bottom: 16px; }
  .qr-box { display: flex; justify-content: center; margin-bottom: 24px; }
  #qrcode { padding: 20px; background: white; border-radius: 16px; border: 1px solid var(--border-soft); }

  .manual h4 { text-align: center; margin-bottom: 6px; }
  .manual p { text-align: center; font-size: 14px; color: var(--text-muted); margin-bottom: 12px; }
  .secret { background: #f8fafc; border: 1px dashed var(--border-soft); border-radius: 12px; padding: 14px; font-family: monospace; font-size: 14px; text-align: center; word-break: break-all; position: relative; }
  .copy-btn { position: absolute; top: 8px; right: 10px; background: var(--primary); color: white; border: none; border-radius: 8px; padding: 6px 10px; font-size: 12px; cursor: pointer; }

  .code-input { margin-top: 24px; }
  .code-input input { width: 100%; padding: 16px; font-size: 24px; text-align: center; letter-spacing: 12px; border-radius: 14px; border: 1px solid var(--border-soft); }

  .button { width: 100%; margin-top: 20px; padding: 14px; border-radius: 999px; border: none; background: var(--primary); color: white; font-size: 16px; font-weight: 600; cursor: pointer; }

  .error, .success { margin-top: 16px; padding: 14px; border-radius: 12px; display: none; font-weight: 600; text-align: center; }
  .error { background: #fee2e2; color: #991b1b; }
  .success { background: #dcfce7; color: #166534; }

  .hint { text-align: center; font-size: 12px; margin-top: 12px; color: var(--text-muted); }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>

<body>
<div class="container">
  <div class="header">
    <h1>Set Up Two-Factor Authentication</h1>
  </div>

  <div class="split">
    <div class="card">
      <div class="step">
        <div class="step-number">1</div>
        <div>
          <h3>Install an Authenticator App</h3>
          <p>Authenticator apps such as <strong>Google Authenticator</strong> or <strong>Microsoft Authenticator</strong> generate secure, time-based codes that you’ll use when signing in.</p>
        </div>
      </div>

      <div class="step">
        <div class="step-number">2</div>
        <div>
          <h3>Scan the QR Code</h3>
          <p>Open your authenticator app, tap “Add Account” or the “+” icon, then scan the QR code shown on the right.</p>
        </div>
      </div>

      <div class="step">
        <div class="step-number">3</div>
        <div>
          <h3>Verify & Complete Setup</h3>
          <p>Enter the 6-digit code currently shown in your authenticator app.</p>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="qr-title">Scan this QR code</div>
      <div class="qr-sub">Use your authenticator app</div>

      <div class="qr-box">
        <div id="qrcode"></div>
      </div>

      <div class="manual">
        <h4>Can’t scan the QR code?</h4>
        <p>Enter this setup key manually</p>
        <div class="secret">
          <button class="copy-btn" onclick="copySecret()">Copy</button>
          <span id="secret"></span>
        </div>
      </div>

      <div class="code-input">
        <input type="text" id="code" maxlength="6" inputmode="numeric" placeholder="000000" />
      </div>

      <button class="button" id="verifyBtn" onclick="verifyAndEnable()">Verify & Enable Two-Factor Authentication</button>

      <div id="error" class="error"></div>
      <div id="success" class="success"></div>

      <div class="hint">
        Your connection is secure. Codes refresh every 30 seconds.
      </div>
    </div>
  </div>
</div>

<script>
  const params = new URLSearchParams(window.location.search);
  const secret = params.get('secret');
  const qrData = decodeURIComponent(params.get('qr'));
  const state = params.get('state');

  // NEW: Handle attemptsLeft for MFA enrollment
  let attemptsLeft = parseInt(params.get('attemptsLeft') || '3', 10);
  const errorMessage = params.get('error');

  if (errorMessage) {
    const errorDiv = document.getElementById('error');
    errorDiv.textContent = errorMessage + ` (${attemptsLeft} attempts left)`;
    errorDiv.style.display = 'block';
  }

  if (qrData && qrData !== 'null') {
    new QRCode(document.getElementById('qrcode'), {
      text: qrData,
      width: 220,
      height: 220
    });
  }

  document.getElementById('secret').textContent = secret || 'Error';

  function copySecret() {
    navigator.clipboard.writeText(secret);
  }

  function verifyAndEnable() {
    const code = document.getElementById('code').value.trim();
    if (code.length !== 6) return;

    if (attemptsLeft <= 0) {
      alert('Maximum attempts reached. Please try again later.');
      return;
    }

    window.location.href =
      `https://auth.panaroma.ai/continue?state=${state}&code=${code}`;
  }

  document.getElementById('code').addEventListener('input', e => {
    e.target.value = e.target.value.replace(/\D/g, '');
    if (e.target.value.length === 6) {
      setTimeout(verifyAndEnable, 300);
    }
  });
</script>
</body>
</html>
